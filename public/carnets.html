<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistema CCCP</title>
    <link rel="stylesheet" href="Css/styles.css">
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Lobster&family=Montserrat:wght@400;700&display=swap">
</head>
<body>
    <header>
        <img style="background: #000000 !important; margin: 0 auto 0 25px; width: 100px; height: auto;" class="left_col" src="Img/logo2.jpg" alt="Logo Colegio">
        <h1>Colegio Ciencias Comerciales, El Progreso.</h1>
        <a href="login.html" style="
        display: inline-flex;
        align-items: center;
        background-color: white;
        color: black; 
        padding: 10px 20px;
        text-decoration: none;
        border-radius: 5px;
        font-size: 16px;
        font-weight: bold;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        transition: background-color 0.3s, transform 0.3s, box-shadow 0.3s;
    " 
    onmouseover="this.style.backgroundColor='white'; this.style.transform='translateY(-2px)'; this.style.boxShadow='0 6px 8px rgba(0, 0, 0, 0.15)';"
    onmouseout="this.style.backgroundColor='white'; this.style.transform='translateY(0)'; this.style.boxShadow='0 4px 6px rgba(0, 0, 0, 0.1)';"
    onmousedown="this.style.backgroundColor='white';"
    onmouseup="this.style.backgroundColor='white';"
    >
        <span style="
            margin-right: 8px;
            font-size: 18px;
        ">‚¨ÖÔ∏èüö™</span>Cerrar Sesi√≥n
    </a>    
    </header>
    <div class="main-container">
        <aside class="sidebar">
            <div class="seccion-izquierda">
                <img style="background: #fff !important; margin: 0 auto 0 50px; width: 180px; height: auto;" class="left_col" src="Img/logo.png" alt="Logo Colegio">
                <h2 class="about-title">Acerca del Colegio</h2>
            </div>
            <ul class="seccion-especial">
                <li>üìö <a href="historia.html">Historia del Colegio</a></li>
                <li>üéØ <a href="mision_vision.html">Misi√≥n y Visi√≥n</a></li>
                <li>üë®‚Äçüè´ <a href="personal_docente.html">Personal Docente</a></li>
                <li>üè¢ <a href="infraestructura.html">Infraestructura</a></li>
                <li>üìú <a href="reglamentos_politica.html">Reglamentos y Pol√≠ticas</a></li>
                <li>üíª <a href="plataformas_recursos.html">Plataformas y Recursos</a></li>
                <li>üéì <a href="perfil_docente.html">Perfil del Docente</a></li>
                <li>üìû <a href="contactanos.html">Cont√°ctanos</a></li>
            </ul>
        </aside>
        <div class="content">
            <nav>
                <ul>
                    <li><a href="/inicio.html">Inicio</a></li>
                    <li><a href="/docentes.html">Docentes</a></li>
                    <li><a href="/horarios.html">Horarios</a></li>
                    <li><a href="/descansos.html">Descansos</a></li>
                    <li><a href="/asistencias.html">Asistencias</a></li>
                    <li><a href="/carnets.html">Carnets</a></li>
                    <li><a href="/eventos.html">Eventos</a></li>
                    <li><a href="/permisos.html">Permisos</a></li>
                    <li><a href="planilla.html">Planilla</a></li>
                </ul>
                <style>
                /* Estilos originales */
                body {
                    background-color: #f0f0f0;
                    font-family: Arial, sans-serif;
                    margin: 0;
                    padding: 0;
                }
                
                .container {
                    width: 80%; /* Ancho ajustado para que coincida con tu dise√±o */
                    margin: 20px auto; /* Centrado con margen superior */
                    padding: 20px;
                    background-color: white;
                    border-radius: 8px;
                    box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
                }
                
                h1 {
                    text-align: center;
                    color: blue;
                    font-family: 'Montserrat', sans-serif;
                }
                
                
                .date-navigation {
                    display: flex;
                    justify-content: space-between;
                    align-items: center;
                    margin-bottom: 20px;
                }
                
                .date-navigation button {
                    padding: 10px 20px;
                    background-color: #ffff00;
                    color: black;
                    border: none;
                    cursor: pointer;
                    border-radius: 4px;
                    font-size: 1rem;
                    transition: background-color 0.3s ease;
                }
                
                .date-navigation button:hover {
                    background-color: #ffff00;
                }
                
                .date-display {
                    font-size: 18px;
                    font-weight: bold;
                }
                
                table {
                    width: 100%;
                    border-collapse: collapse;
                    margin-top: 20px;
                }
                
                th, td {
                    border: 1px solid #ddd;
                    padding: 12px;
                    text-align: center;
                }
                
                th {
                    background-color: #ff6600;
                    color: black;
                    font-size: 1rem;
                }
                
                td {
                    font-size: 0.95rem;
                }
                
                /* Estilo del campo de entrada de c√≥digo (scanner) */
                .input-container {
                    text-align: center;
                    margin-top: 20px; /* Separaci√≥n entre la tabla y el input */
                }
                
                #scannerInput {
                    display: inline-block;
                    padding: 10px;
                    width: 300px; /* Ajustar el ancho del campo */
                    border-radius: 8px;
                    border: 1px solid #ddd;
                    font-size: 16px;
                    box-shadow: 0 0 5px rgba(0, 0, 0, 0.1);
                    outline: none;
                }
                
                /* Responsividad para pantallas peque√±as */
                @media (max-width: 768px) {
                    .container {
                        width: 95%;
                        padding: 15px;
                    }
                
                    .date-navigation {
                        flex-direction: column;
                        gap: 10px;
                    }
                
                    table, th, td {
                        font-size: 0.85rem;
                        padding: 8px;
                    }
                
                    #scannerInput {
                        width: 100%; /* Ocupa todo el ancho disponible en pantallas peque√±as */
                    }
                }
            </style>
                <script src="https://cdn.jsdelivr.net/npm/jsbarcode@3.11.5/dist/JsBarcode.all.min.js"></script>

                <h1>Generador y Lector de C√≥digos de Barras</h1>
            
                <!-- Formulario para Generar Carnet -->
                <div class="form-group">
                    <label for="docenteSelect">Selecciona el docente:</label>
                    <select id="docenteSelect">
                        <option value="">-- Selecciona un docente --</option>
                        <!-- Opciones se llenar√°n din√°micamente -->
                    </select>
                </div>
            
                <div class="form-group">
                    <label for="barcodeFormat">Selecciona el formato del c√≥digo de barras:</label>
                    <select id="barcodeFormat">
                        <option value="CODE128">CODE128</option>
                        <option value="EAN13">EAN13</option>
                        <!-- Agrega m√°s formatos seg√∫n tus necesidades -->
                    </select>
                </div>
            
                <div class="form-group">
                    <label for="barcodeValue">Ingresa el c√≥digo:</label>
                    <input type="text" id="barcodeValue" placeholder="Ingrese el c√≥digo aqu√≠">
                </div>
            
                <!-- Nuevos campos para fechas y descripci√≥n -->
                <div class="form-group">
                    <label for="fechaEmision">Fecha de Emisi√≥n:</label>
                    <input type="date" id="fechaEmision">
                </div>
            
                <div class="form-group">
                    <label for="fechaVencimiento">Fecha de Vencimiento:</label>
                    <input type="date" id="fechaVencimiento">
                </div>
            
                <div class="form-group">
                    <label for="descripcion">Descripci√≥n:</label>
                    <input type="text" id="descripcion" placeholder="Ingrese una descripci√≥n">
                </div>
            
                <button id="generateButton" style="background-color: #ffff00; /* Color verde */color: black; /* Texto blanco */border: none;padding: 10px 20px;font-size: 16px;border-radius: 5px;cursor: pointer;transition: background-color 0.3s ease;">Generar C√≥digo de Barras</button>            
                <!-- √Årea para Mostrar el C√≥digo de Barras -->
                <div id="barcode">
                    <canvas id="barcodeCanvas" width="300" height="100"></canvas>
                </div>
            
                <button id="printButton" style="display:none;"></button>
            
                <!-- Tabla de Carnets Generados -->
                <h2>Lista de Carnets Generados</h2>
                <table id="carnetsTable">
                    <thead>
                        <tr>
                            <th>ID</th>
                            <th>Docente</th>
                            <th>C√≥digo</th>
                            <th>N√∫mero de Carnet</th>
                            <th>Fecha de Emisi√≥n</th>
                            <th>Fecha de Vencimiento</th>
                            <th>Descripci√≥n</th>
                        </tr>
                    </thead>
                    <tbody>
                        <!-- Se llenar√° din√°micamente -->
                    </tbody>
                </table>
            
                <!-- Scripts JavaScript -->
                <script>
                    // Funci√≥n para cargar los docentes en el selector
                    async function cargarDocentes() {
                        try {
                            const response = await fetch('http://localhost:4000/api/docentes');
                            if (response.ok) {
                                const docentes = await response.json();
                                const select = document.getElementById('docenteSelect');
                                docentes.forEach(docente => {
                                    const option = document.createElement('option');
                                    option.value = docente.Codigo;
                                    option.textContent = `${docente.Nombres} ${docente.Apellidos} (${docente.Correo_electronico})`;
                                    select.appendChild(option);
                                });
                            } else {
                                console.error('Error al cargar los docentes:', response.statusText);
                            }
                        } catch (error) {
                            console.error('Error al comunicarse con la API de docentes:', error);
                        }
                    }
            
                    // Funci√≥n para validar el c√≥digo seg√∫n el formato
                    function esValidoParaFormato(noCarnet, format) {
                        const regex = {
                            'CODE128': /.*/, // cualquier cosa
                            'EAN13': /^\d{12}$/, // 12 d√≠gitos
                            'UPC': /^\d{11}$/ // 11 d√≠gitos
                            // Agrega m√°s formatos seg√∫n tus necesidades
                        };
                        return regex[format] ? regex[format].test(noCarnet) : false;
                    }
            
                    // Funci√≥n para generar y mostrar el c√≥digo de barras en Canvas
                    function generarBarcode(value, format) {
                        try {
                            const canvas = document.getElementById('barcodeCanvas');
                            // Limpiar el canvas antes de dibujar
                            const ctx = canvas.getContext('2d');
                            ctx.clearRect(0, 0, canvas.width, canvas.height);
            
                            JsBarcode(canvas, value, { format: format, displayValue: true });
                            console.log(`C√≥digo de barras generado: ${value} con formato ${format}`);
                        } catch (error) {
                            alert('Error al generar el c√≥digo de barras: ' + error.message);
                            console.error('Error al generar el c√≥digo de barras:', error);
                        }
                    }
            
                    // Funci√≥n para imprimir el c√≥digo de barras
                    function imprimirBarcode() {
                        const printContents = document.getElementById('barcode').innerHTML;
                        const originalContents = document.body.innerHTML;
            
                        document.body.innerHTML = printContents;
                        window.print();
                        document.body.innerHTML = originalContents;
                        location.reload(); // Recargar la p√°gina para restaurar el contenido
                    }
            
                    // Funci√≥n para convertir Canvas a PNG y descargar
                    function descargarBarcode(carnetId, codigo, formato) {
                        try {
                            // Crear un canvas temporal
                            const tempCanvas = document.createElement('canvas');
                            tempCanvas.width = 300; // Ancho del canvas
                            tempCanvas.height = 100; // Alto del canvas
                            const tempCtx = tempCanvas.getContext('2d');
            
                            // Generar el c√≥digo de barras en el canvas temporal
                            JsBarcode(tempCanvas, codigo, { format: formato, displayValue: true });
            
                            // Obtener el PNG del canvas
                            const pngData = tempCanvas.toDataURL('image/png');
                            console.log(`PNG generado para carnet ${carnetId}:`, pngData);
            
                            // Crear un enlace para descargar el PNG
                            const link = document.createElement('a');
                            link.href = pngData;
                            link.download = `carnet_${carnetId}.png`;
                            document.body.appendChild(link);
                            link.click();
                            document.body.removeChild(link);
                        } catch (error) {
                            console.error('Error al convertir Canvas a PNG:', error);
                            alert('Ocurri√≥ un error al descargar el carnet.');
                        }
                    }
            
                    // Funci√≥n para cargar y mostrar todos los carnets
                    async function cargarCarnets() {
                        try {
                            const response = await fetch('http://localhost:4000/carnets');
                            if (response.ok) {
                                const carnets = await response.json();
                                const tbody = document.getElementById('carnetsTable').querySelector('tbody');
                                tbody.innerHTML = ''; // Limpiar tabla
            
                                carnets.forEach(carnet => {
                                    // Extraer el formato de la descripci√≥n
                                    const match = carnet.Descripcion.match(/formato\s+(\w+)/i);
                                    const formato = match ? match[1].toUpperCase() : 'CODE128';
            
                                    const tr = document.createElement('tr');
                                    tr.innerHTML = `
                                        <td>${carnet.Id_carnet}</td>
                                        <td>${carnet.Nombres} ${carnet.Apellidos}</td>
                                        <td>${carnet.Codigo}</td>
                                        <td>${carnet.No_carnet}</td>
                                        <td>${carnet.Fecha_emision}</td>
                                        <td>${carnet.Fecha_vencimiento}</td>
                                        <td>${carnet.Descripcion}</td>
                                        <td>
                                            <button class="deleteButton" data-id="${carnet.Id_carnet}" style="background-color: #dc3545; color: white; border: none; padding: 5px 10px; cursor: pointer; border-radius: 3px;">
                                                üóëÔ∏è Eliminar
                                            </button>
                                            <button class="downloadButton" data-id="${carnet.Id_carnet}" data-codigo="${carnet.No_carnet}" data-formato="${formato}" style="background-color: #ffff00; color: black; border: none; padding: 5px 10px; cursor: pointer; border-radius: 3px;">
                                                üíæ Descargar
                                            </button>
                                        </td>
                                    `;
                                    tbody.appendChild(tr);
                                });
            
                                // A√±adir eventos a los botones de eliminar
                                document.querySelectorAll('.deleteButton').forEach(button => {
                                    button.addEventListener('click', async (event) => {
                                        const id_carnet = event.target.getAttribute('data-id');
                                        if (confirm('¬øEst√°s seguro de que deseas eliminar este carnet?')) {
                                            try {
                                                const deleteResponse = await fetch(`http://localhost:4000/carnets/${id_carnet}`, {
                                                    method: 'DELETE'
                                                });
                                                if (deleteResponse.ok) {
                                                    alert('Carnet eliminado exitosamente.');
                                                    cargarCarnets(); // Recargar la tabla de carnets
                                                } else {
                                                    const errorData = await deleteResponse.json();
                                                    alert(`Error al eliminar el carnet: ${errorData.message}`);
                                                }
                                            } catch (error) {
                                                console.error('Error al comunicarse con la API:', error);
                                                alert('Ocurri√≥ un error al eliminar el carnet.');
                                            }
                                        }
                                    });
                                });
            
                                // A√±adir eventos a los botones de descargar
                                document.querySelectorAll('.downloadButton').forEach(button => {
                                    button.addEventListener('click', async (event) => {
                                        const carnetId = event.target.getAttribute('data-id');
                                        const codigo = event.target.getAttribute('data-codigo');
                                        const formato = event.target.getAttribute('data-formato');
            
                                        console.log(`Descargando carnet ID: ${carnetId}, C√≥digo: ${codigo}, Formato: ${formato}`);
            
                                        // Validar que el c√≥digo sea v√°lido para el formato
                                        if (!esValidoParaFormato(codigo, formato)) {
                                            alert(`El c√≥digo ingresado no es v√°lido para el formato ${formato}.`);
                                            console.log(`Validaci√≥n fallida: C√≥digo ${codigo} no es v√°lido para el formato ${formato}`);
                                            return;
                                        }
            
                                        // Descargar el c√≥digo de barras como PNG
                                        descargarBarcode(carnetId, codigo, formato);
                                    });
                                });
                            } else {
                                console.error('Error al cargar los carnets:', response.statusText);
                            }
                        } catch (error) {
                            console.error('Error al comunicarse con la API:', error);
                        }
                    }
            
                    // Evento para el bot√≥n de generar carnet
                    document.getElementById('generateButton').addEventListener('click', async () => {
                        const docenteCodigo = document.getElementById('docenteSelect').value;
                        const format = document.getElementById('barcodeFormat').value;
                        const value = document.getElementById('barcodeValue').value.trim();
                        const fechaEmision = document.getElementById('fechaEmision').value;
                        const fechaVencimiento = document.getElementById('fechaVencimiento').value;
                        const descripcion = document.getElementById('descripcion').value.trim();
            
                        // Validaciones
                        if (!docenteCodigo) {
                            alert('Por favor, selecciona un docente.');
                            return;
                        }
            
                        if (!value) {
                            alert('Por favor, ingresa un c√≥digo.');
                            return;
                        }
            
                        if (!fechaEmision) {
                            alert('Por favor, selecciona la fecha de emisi√≥n.');
                            return;
                        }
            
                        if (!fechaVencimiento) {
                            alert('Por favor, selecciona la fecha de vencimiento.');
                            return;
                        }
            
                        if (new Date(fechaVencimiento) <= new Date(fechaEmision)) {
                            alert('La fecha de vencimiento debe ser posterior a la fecha de emisi√≥n.');
                            return;
                        }
            
                        // Validar si el 'value' es v√°lido para el formato seleccionado
                        if (!esValidoParaFormato(value, format)) {
                            alert(`El c√≥digo ingresado no es v√°lido para el formato ${format}.`);
                            console.log(`Validaci√≥n fallida: C√≥digo ${value} no es v√°lido para el formato ${format}`);
                            return;
                        }
            
                        // Generar y mostrar el c√≥digo de barras
                        generarBarcode(value, format);
            
                        // Mostrar el bot√≥n de imprimir
                        document.getElementById('printButton').style.display = 'inline-block';
            
                        // Crear el objeto carnet
                        const carnet = {
                            Codigo: parseInt(docenteCodigo),
                            No_carnet: value,
                            Fecha_emision: fechaEmision,
                            Fecha_vencimiento: fechaVencimiento,
                            Descripcion: descripcion || `Carnet generado con formato ${format}`
                        };
            
                        try {
                            // Enviar el carnet a la API para guardar en la base de datos
                            const response = await fetch('http://localhost:4000/carnets', { // Aseg√∫rate de que esta URL sea correcta
                                method: 'POST',
                                headers: {
                                    'Content-Type': 'application/json'
                                },
                                body: JSON.stringify(carnet)
                            });
            
                            if (response.ok) {
                                const data = await response.json();
                                alert('C√≥digo de barras generado y carnet asignado exitosamente.');
                                cargarCarnets(); // Recargar la tabla de carnets
                            } else {
                                const errorData = await response.json();
                                alert(`Error al guardar el carnet: ${errorData.message}`);
                            }
                        } catch (error) {
                            console.error('Error al comunicarse con la API:', error);
                            alert('Ocurri√≥ un error al guardar el carnet.');
                        }
                    });
            
                    // Evento para el bot√≥n de imprimir carnet
                    document.getElementById('printButton').addEventListener('click', imprimirBarcode);
            
                    // Cargar los docentes y carnets al iniciar la p√°gina
                    window.onload = () => {
                        cargarDocentes();
                        cargarCarnets();
                    };
                </script>
            
            </body>
            </html>